跨链桥概述
## 跨链的目的
主要有三种

- 资产传递，如将BTC从比特币网络跨链到以太坊网络，得到WBTC
- 资产交换，如将BTC从比特币网络跨链到以太坊网络，得到等值的ETH
- 信息传递，让链间的任何消息进行可靠的传递，比如A链合约产生交易后，交易信息传递到B链，调用B链合约的方法


## 跨链资产托管方式
目前场景的资产托管方式如下图：

![image.png](https://cdn.nlark.com/yuque/0/2024/png/34890996/1708780868523-2c803701-a61b-4395-be6e-a7b176459d37.png#averageHue=%23f8f8f8&clientId=u83e3f135-2ae7-4&from=paste&height=435&id=u53169ae3&originHeight=652&originWidth=737&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=80128&status=done&style=none&taskId=u606cc318-803a-414d-974b-84f3d08af7d&title=&width=491.3333333333333)
## 技术概览
区块链之间不能直接通信，需要搭建通信桥梁。在通信桥梁选择上，通常来说分为四大类技术形态，分别是基于哈希时间锁的原子交换，公证人，轻节点侧链，中继链现概述如下。
### 基于哈希时间锁的原子交换
哈希时间锁是一套密码学方法，该方法可以实现去信任的跨链资产交易。

![image.png](https://cdn.nlark.com/yuque/0/2024/png/34890996/1708780882320-d151a597-42c7-46e5-afa0-52af95ed4c8f.png#averageHue=%23f9f8f7&clientId=u83e3f135-2ae7-4&from=paste&height=275&id=u6e9d4a1b&originHeight=413&originWidth=800&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=118144&status=done&style=none&taskId=u28d1d958-748b-4255-9d49-400e17769cf&title=&width=533.3333333333334)


优点：
通过以上机制，在两条不同链上的交易，被耦合为一个事件，只能整体成功，或者整体失败，不会出现A给B的转账成功，而B给A的转账失败的情况，反之亦然。
缺点：
1 用户不友好，很难找到互相匹配的交易对手，双方必须同事在线操作，且操作技术相对复杂。
2 存在汇率问题，如果在时间范围内，交易对手可根据汇率来考虑是否完成交易。交易也可能由于价格波动而被单方面终止。


### 公证人模式
如果一个机构在多条链上都持有资产，那么可以通过该机构进行跨链交易。用户在源链上先把钱给公证人，然后公证人保证在目标链上把钱转给用户。可以分为如下三类：
单个公证人，最典型的就是交易所，如币安、coinbase等。
多个公证人（多签），用户在源链上先把钱转给公证人的多签地址，在目标链上，再把钱转给用户。接收到用户的钱，使用m-n的多签管理，避免公证人集体拿钱跑路。
多个公证人（MPC），逻辑和多签类似，区别在于MPC（Multi-Party-Computation），是一种私钥分片技术。多签账户是多个私钥管理一个账户，而 MPC 账户则是一个私钥管理一个账户，该私钥被切分为多个碎片，多个签名人各持有一个私钥碎片，当签名人数达到阈值时才可以合成完整的签名。


公证人的选择，大概也有两种模式：

- 尽可能选择信誉良好的大公司、知名机构。对于这些机构而言，作恶的成本极高，可能会损失掉积累多年的商誉。比如跨链桥项目 Wormhole 就选择了这样的模式，它的 19 个节点背后都是体量庞大、资金雄厚的知名大机构。
- 采用无准入条件的公证人，但要求他们做质押，如果行为不端，他们质押的资金就会被扣除。这种方式一般是 PoS+BFT 的方式。ZetaChain 用的便是这种。



优缺点：
单个公证人依靠他在链下积累的声誉权威，实现快速，成本低廉，中心化比较重。
多签方式，如果选择的参与方具备良好声誉、不同地理分布，m-n选择合理，则用户资金能得到充分保证。缺点是，多签签名方需要一开始就确定好，后面替换参与方或修改m-n会麻烦一些，涉及系统和合约升级，资金迁移；另外一个问题是，时间久了，所有的多签参与方都会暴漏，黑客有可能会逐个盗取多签私钥，从而盗取资金（之前Axie跨链桥就被盗取了2/3的多签签名私钥）。
MPC方式，MPC签名后，交易看起来和单签基本一致，黑客无法知道背后具体的私钥分片数量，且更换（修改碎片数量、签名阈值）比多签更方便。缺点是，在生成私钥或需要签名时，始终会形成一个私钥，此时存在私钥暴漏的风险，不过也有一些措施可以进行改进，比如汇总私钥碎片签名时，在TEE可信执行环境（Trusted Execute Environment ）中进行，避免私钥被获取。


### 轻节点侧链
所谓轻节点，是指一个体积较小的，只存储区块头信息的节点。轻节点并不存储链上的全部交易，但是可以通过区块头信息，验证某个交易是否存在于链上。轻节点合约则是包含了轻节点的智能合约。通过在目标链部署源链的轻节点合约，即可实现对源链来的消息进行真实性验证。其过程大致如下：


- 当源链A有请求传递一笔跨链交易信息给目标链B时，交易发起者将该交易的明细内容、区块高度、以及该交易SPV证明（指该交易的Mekre路径）一并提交到B链；
- 部署在B链上的A链轻节点合约，通过SPV证明，重新计算该交易所在区块的区块头哈希值；
- 得到的哈希值与轻节点中对应的区块头哈希值进行比较，如果一致，则表明该交易确实发生在该区块中，若不一致，则说明该交易并不存在于该区块。


负责在A链和B链间实现消息传递的角色，通常叫做Relayer。


优点：
1 Relayer不负责托管资产，通常资产由源链的锁仓合约进行管理，该合约通常经过多家安全公司审计，比公证人托管更加安全可靠。
2 Relayer对对公证人的信任依赖更小，多签或MPC方式，需要有m-n的一个门限信任，而这里只需要信任至少一个Relayer是诚实的，他能正确把A链的区块头传递到B链合约进行验证。
3 公证人机制重在Trust（信任），轻节点侧链则重在Verify（验证）。 通过区块头验证交易信息，其可靠性是在密码学上被保障的，交易是否存在，一验即知，确定无疑。
缺点：
1 跨链的开发成本增加了很多，每一对区块链，除需要运行双向的Relayer，每条链上都需要有对应合约，如果有m条链需要互跨，那么工作量会急剧增加，达到m*(m-1)/2倍。
2 存在汇率问题，如果在时间范围内，交易对手可根据汇率波动来考虑是否完成交易。

### 中继链
轻节点侧链方案中，如果把要跨多链的工作提炼出来，专门做一条中继链，和所有链都建立连接，成本立即从 m(m-1)/2 下降到了m（m为链的数量）。这就是中继链方案，比较典型的有波卡。中继方案具有很高的扩展性，是当前最被广泛应用的跨链方案。

优点：
降低了跨链成本，高度可扩展，支持的生态也多。
缺点：
一旦被攻击，影响较大，跨链桥有几笔攻击，损失都超过1亿美金以上。


# BTC跨链桥风险预防措施


风险隔离：跨链资产的管理，建议分池子进行管理，如有链A、B、C，对AB AC BC三个链对的资金，各自使用不同的托管钱包进行管理，不要使用统一的资金池。如遇被盗，也只能盗取特定链对的资金池，其他链对不受影响。

冷热钱包：因为链上要及时处理跨链请求，则托管账户必定是热钱包，容易受到攻击。可以考虑启用冷热钱包互补机制，当热钱包托管资金量超过一定额度后，将超过部分转到冷钱包（可以有多个，且也应该是多签或MPC）托管，并限制热钱包单笔转账额度，当热钱包资金低于某个额度时，冷钱包向热钱包补充资金。这个机制类似于交易所的钱包托管。


TEE：转账签名的时候，即签名机，可以使用TEE环境，防止私钥泄露。


监控：开发跨链监控程序，当检测到异常时，可暂停跨链服务，防止造成损失。


脱锚：跨链资产应严格按照1：1锚定，不应随意增发或销毁，避免出现脱锚的情况。

质押：跨链后的网络需要提供足够的实际资产质押，以保证节点不会联合作恶。


# BTC跨链桥案例详解
# BEVM
BEVM是一款基于ChainX进行二次开发的Bitcoin二层网络，其融合了其他平台的技术，并尽可能的利用了Bitcoin Core 0.21之后的一些特性，例如taproot，深度默克尔树，聚合签名方案等。这些站在巨人肩膀上的行为，以及它宣称对Ordi铭文的支持，使得其在最近的Bitcoin layer2方案中占据了极高的话题度，并且网络中也已经存在近千万级别的资产。
我们认为BEVM的实现相对本章节可能提到的其他方案，是显然最具有时效性，可靠性，典型性和参考性的方案，因此我们将重点对其进行详细的说明，展示它的框架和构建细节。
### 总体框架
以BEVM为首的，试图将功能可扩展性引入Bitcoin Layer2的各类尝试，其最核心的思想在于两点，分别为：使用类似Rollup的思想，能够令比特币网络核对二层网络账户状态的实现，以及将某个比特币地址，通过一些方法转换为一个类似于以太坊当中的合约地址。总体来说，其运作方式可以用下图进行表示：


![image.png](https://cdn.nlark.com/yuque/0/2024/png/34890996/1708780908553-9c83cf34-22e7-472b-b28c-87a19f08afe6.png#averageHue=%23fcfcfc&clientId=u83e3f135-2ae7-4&from=paste&height=255&id=u89b4b0e7&originHeight=383&originWidth=841&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=31906&status=done&style=none&taskId=u60f0c38d-8820-4cbc-9ded-9082485b65d&title=&width=560.6666666666666)


	图中，蓝线表示资产从比特币网络跨链到BEVM网络，红线表示从资产从BEVM重新回到比特币网络。事实上，Taproot账户就和以太坊中的合约地址的概念类似，比特币中的用户A通过将比特币发送到BEVM指定的，包含了Tapscript的，一个使用了聚合公钥的账户之中，事实上就已经完成了跨链（我们甚至可以认为，跨链桥就是这个taproot地址）。


### 3.1.2 资产进入和使用


在图中，A将10个btc发送到了跨链桥当中；随后，跨链桥的节点（矿工）接受到了这笔交易。注意，在BEVM当中，每个矿工都需要同时运行一个比特币网络的轻节点，以便于快速的识别比特币中打过来的交易。在确定A将10块钱打入taproot地址之后，矿工们将根据协议，在另外一个和用户A商议好（或者在生成之后发送给他）的地址B中，加入10个BEVM btc，在这里我们简称xbtc。需要注意，这个过程和多签，聚合签名之类的技术都没有关系。


显然，用户A对于位于BEVM当中的地址B拥有完全的所有权，在成功时候到了10个xbtc之后，它就可以用xbtc在BEVM中，和BEVM的合约地址进行交互了。在图中，Contract VM指搭载了合约代码的，BEVM合约地址。地址B可以通过xbtc与之进行交互，并且和其他的BEVM地址通过合约进行资产交换。在访问合约的时候，由于资产发生了变化，而这些变化显然应该反应在Taproot的账户当中，因此这里产生了两种做法：


（1）所有的状态变化，都应该能够在Taproot的地址中展现出来（例如，对不同的用户设置不同的找零地址）


（2）变化只需要在进行提款的时候进行体现即可


目前BEVM采用的是第二种方法，因此，这带来了一个衍生的问题（或者缺点），就是BEVM不支持除了ORDI之外的铭文。这是由于在提款时，BEVM事实上不会对某一笔UXTO做特殊的找零，而是会全部当做同质化代币处理。归根究底，这正是因为没有对每一个存入跨链桥的账户做特殊的找零处理（状态变化）所导致的问题。但之所以没有这样做，主要还是出于效率和费用的考虑。
### 3.1.3 资产退出
任意一笔资产，例如用户A，如果希望退出BEVM，显然从实质上看，就是Taproot地址会将一笔资金发往A，完成整个生命周期。在图中，A在BEVM的合约中消耗了1个xbtc，因此显然它只能从taproot地址中提取出9个btc。


在进行退出的时候，事实上需要地址B先往BEVM当中某个特殊的合约地址发送xbtc，才能够开始整个退出流程。为了简便，图中也使用了contract VM表示这个特殊合约。在合约收到这个退出信号之后（事实上就是BEVM的矿工收到了这个信号），它们就会开始通过POS+PBFT的共识进行通信，并试图生成门限签名所需要的秘钥。在这里，我们暂时将整个过程理解为：Taproot账号使用了一个多签公钥，并通过tapscript指定了一个n-m的门限签名；这里n指需要多少个签名，m指一共存在多少个签名。在BEVM当中， 3n = 2m。只要有三分之二的矿工同意，最终矿工们就能够生成秘钥，并且构造一笔合法的，从taproot账户发送9个btc到A账户的交易。


最终，账户B中的9个xbtc被销毁，taproot账户通过网络中2/3个矿工所构造的多签交易（并满足了tapscript），构造了一笔发往A账户的交易，注意，这笔交易位于比特币网络。在这笔交易得到了足够多的确认之后，A将收到9个btc，整个跨链生命周期结束。


	构造taproot账户以及tapscript

	从以上的流程中可以看到，Bevm从工程实践的角度看，最关键的部分显然就是如何构造这个taproot账户，以及这个账户对应的tapscript应该如何构造。在Bitcoin Core 0.24中，创建方式非常的简单，通过在Output Descriptors创建以下指令即可：tr(KI,multi_a(21,K1,K2,K3,K4,...,K210))，其中，每个K都对应一个multisig的私钥碎片。与此同时，创建多签钱包也并不困难，通过createmultisig以及addmultisigaddress命令，也能够在QT客户端返回对应的Output Descriptors来创建。
	
比较困难的问题在于创建聚合签名（如schnorr签名），以及构造适合聚合签名的tapscript，不过幸运的是目前已经有了一些解决方案，例如bip-0340提案。但是请注意，目前聚合签名方案还没有被bitcoin core所收录，因此，具体的聚合过程需要项目方自己进行完成。但是Tapscript支持对schnorr签名进行验证，通过OP_CHECKSIGADD指令，能够累进式的判断最终签名是否成功。


### 3.1.4 BEVM的优缺点
总体来说，BEVM是一个比较完整的比特币二层网络的实现。相较于侧链和离链的实现，其资产事实上还处于BTC网络中，因此其最终的状态100%由比特币网络确定；相较于其他的二层方案，它能够支持去中心化的执行方式，因此安全性更加具有保障。
但是BEVM也存在一些缺点，其中比较主要的就是对脚本的支持还有所欠缺；同时，它并不能做到和rollup一样，完全的将状态展现在taproot地址当中。


# ckBTC
相较于之前的方案，ckBTC实际上更加接近一个侧链方案，其运作机制与wBTC并无特别大的差别，但是其优点在于能够支持使用ckBTC进行Dapp的开发，间接的令比特币能够运行智能合约，从而更像是一个带有功能性的Bitcoin Layer2,。总体而言，它的表现介于BEVM和wBTC之间。


### 运作流程
	参考BEVM，ckbtc的运作机制基本上是差不多的，如下图所示：
![image.png](https://cdn.nlark.com/yuque/0/2024/png/34890996/1708780949652-ce06a5ed-4c15-4c1e-8eeb-172c05210cb7.png#averageHue=%23fafafa&clientId=u83e3f135-2ae7-4&from=paste&height=235&id=u02e15423&originHeight=352&originWidth=1129&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=59844&status=done&style=none&taskId=uec17d460-8413-42a1-a8be-00e09ea125f&title=&width=752.6666666666666)
	具体来说，虽然ckBTC声称自己并不是一种warpped的BTC，但实际上，它也要求用户首先将btc传输到对应的特殊账户中。在icp节点会持续的监听这个账户，如果其中的UTXO与出块奖励无关，它们就会选择立刻铸造对应的ckBTC并交给对应的账户，否则会多等待几个确认，以保证该区块不会被撤销。
	如果用户希望回收它们的btc，它需要发送信息给icp网络，之后，用户的ckbtc会被销毁，同时该账户会通过一笔交易将金额返还给用户。
### 二层网络合约
	显然，为了能够同步比特币网络的状态，icp节点也需要同时运行一个比特币的轻节点。为了简洁性，icp节点将比特币网络的同步功能进行了整合，从而不用单独运行比特币的客户端。相较于BEVM，icp对同步的要求更高，它几乎会对比特币网络进行完全的同步，包括所有的UTXO信息，来保证能够实时验证比特币中任意地址的状态。
![image.png](https://cdn.nlark.com/yuque/0/2024/png/34890996/1708780961177-ec33bd00-a144-4aa5-9642-e12ae71a16e6.png#averageHue=%23fcfcfc&clientId=u83e3f135-2ae7-4&from=paste&height=348&id=uaff2358f&originHeight=522&originWidth=1130&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=107079&status=done&style=none&taskId=ue00a825b-2797-4daf-8be7-8710ca242bd&title=&width=753.3333333333334)
	具体来说，icp通过一类叫做BTC canister的角色，通过ICP的协议堆栈集成并进行通信。其分别为ckBTC铸币机和ckBTC分账者。ckBTC铸币机在接收比特币时铸造新的ckBTC代币。同样，每当ckBTC代币的持有者请求提取比特币时，它都会销毁ckBTC代币。ckBTC铸币机在铸造ckBTC之前会等待大量的确认，而在将BTC转回用户之前会销毁ckBTC。


对于将BTC转移到用户的操作，采用了最佳努力的方法，即用户无法获得被销毁的ckBTC。相反，ckBTC铸币机会反复尝试将BTC转出，直到转账成功。需要注意的是，“用户”是指下文中由ckBTC铸币机和ckBTC分类帐公开的功能的调用者。这个调用者可以是人类用户，也可以是另一个canister。


ckBTC分账机则比较简单，其实就是负责维护ckbtc的在icp网络的本地账本，在ckBTC代币被转移时它会更新余额账户，并执行来自ckBTC铸币机的铸币和销毁操作。


### 去中心化
	在icp中，并没有采用比特币最近比较关注的聚合签名方案；为了实现多签（门限签名），icp采用了一种叫做链式ECDSA密钥的密码学工具。不过无论如何，这个工具实际上的效果就是将普通的ECDSA的秘钥转化为能够逐个进行验证的门限签名，实际上效果与schnorr签名并无太大差别。但是其优点在于目前比特币主流上更加支持ECDSA，因此可以在不用依赖tapscript的基础上也能做到比较灵活的多签。
	当前实施的ECDSA链密钥签名协议使用单个主私钥，可以使用类似BIP-32的密钥派生来为canisters生成密钥。每个canister都有一个这样的根密钥，使用canister id可以派生出一个，还可以使用BIP-32的向后兼容扩展来派生任意数量的其他canister密钥。最初，在icp上的一个签名子网上部署了ECDSA链密钥签名，该子网将回应canisters的签名请求。签名子网强制规定，只有控制密钥的canister才能请求使用此密钥进行签名。所有由canisters发出的API调用都需要通过XNet流量经过以获得签名相关的额外延迟。Canisters可以查询它们自己或其他canisters的公钥，包括canisters的更多派生公钥。Canisters可以使用它们控制的私钥，即它们的根私钥和派生私钥，请求签名。


### 优缺点
	总体来说，icp是一个特别侧重实用性的方案，通过对比特币网络较为持续性，完整的同步，来保证网络的安全性。通过门限ECDSA签名，来确保网络有一定的去中心化程度。最后，icp也有比较完整的生态和资产，能够将ckbtc用于多链的互通。
	但是icp也具有一个非常显著的缺点，开销太大。同步比特币网络意味着高额的存储，内存，网络压力。显然节点的准入要求比较高，因此其去中心化程度比较难以保证。


# WBTC
BitGo 和 Kyber Network 联合发起WBTC(Wrapped BTC)，是当前铸造量最大的 BTC 锚定资产。


WBTC 对公证人的角色进行了拆分，分为了托管商（ Custodian ，目前只有BitGo）和兑换商( Merchant )。兑换商是介于用户和托管商之间的一个中介角色，将用户和托管商隔绝开来，用户与兑换商交互，兑换商和托管商交互。理论上，兑换商和托管商都不止有一个。无论是兑换商，和还是托管商，都必须是 WBTC DAO 的成员，而 WBTC DAO 成员的新增和清退则由现有成员通过 M-of-N 多签合约来进行许可式管理。


优点：
将铸币和销毁（用户不友好操作，过程缓慢）限制于托管商和兑换商之间，提升了用户跨链体验。


缺点：
资金由单一托管商管理，虽然限制了多签账户只能向白名单（兑换商）转账，但仍然中心化严重，有拒付和跑路风险。


### 关键角色


![image.png](https://cdn.nlark.com/yuque/0/2024/png/34890996/1708780984665-c6696468-f83c-4827-a1ad-e3c5da93228f.png#averageHue=%23f6f5f3&clientId=u83e3f135-2ae7-4&from=paste&height=432&id=ua9471dec&originHeight=648&originWidth=1148&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=295432&status=done&style=none&taskId=u045119e3-1a80-4586-a32b-8cb61eb5d48&title=&width=765.3333333333334)


### WBTC铸造
铸币操作，只能由兑换商发起。

### WBTC销毁
销毁WBTC，只能由兑换商才能发起。

### 用户交换
用户无权申请铸造和赎回，只能向兑换商买入或卖出 WBTC。用户可以用 BTC 和兑换商通过基于哈希时间锁的原子交易换取 WBTC，也可以用同样的方式将 WBTC 换回 BTC。
### 

